(function(){var e,n,o,t,i,r,a,s,c,d,u;window.CAMWIRE={DEBUG:!1},window.CAMWIRE.main=(e=window.mozRTCPeerConnection||window.webkitRTCPeerConnection,n=window.mozRTCSessionDescription||window.RTCSessionDescription,o=window.mozRTCIceCandidate||window.RTCIceCandidate,navigator.getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia,t=!!navigator.mozGetUserMedia,i=!!navigator.webkitGetUserMedia,r={url:i?"stun:stun.l.google.com:19302":"stun:23.21.150.121"},a={url:"turn:homeo@turn.bistri.com:80",credential:"homeo"},s={iceServers:[r]},i&&(parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]>=28)&&(a={url:"turn:turn.bistri.com:80",credential:"homeo",username:"homeo"}),s.iceServers=[r,a]),c=function(){function e(){var e;this.user={},e=this,window.addEventListener("beforeunload",function(){e.part()})}e.displayName="VideoChat";var n,o=e.prototype;return o.onaddstream=function(){},o.onuserleft=function(){},n=function(e,n){var o,i;return o=i=document.createElement("video"),o.id=e,o[t?"mozSrcObject":"src"]=t?n:window.webkitURL.createObjectURL(n),o.autoplay=!0,o.controls=!1,o.play(),o},o.buildStreamHandler=function(e,o){var t;return t=this,function(i){var r,a;i.onended=function(){t.onuserleft(e)},r=n(e,i),e===t.user.id&&(a=r,a.muted=!0,a.volume=0),t.onaddstream(r,i),"function"==typeof o&&o(i)}},o._getUserMedia=function(e){var n,o,t;n={audio:!0,video:!0},o=this.buildStreamHandler(this.user.id,e),t=function(e){window.alert("PermissionDeniedError"===e.name?"Camwi.re could not access your camera. Make sure you granted your browser permission to do so!":"Something went wrong: "+e.name)},navigator.getUserMedia(n,o,t)},o.setSignaller=function(e){return this.sig=e},o.join=function(e){var n;return null==this.sig?void console.error("No signaller set!"):(n=this,void this._getUserMedia(function(o){n.stream=o,n.sig.signal("join",{roomid:e})}))},o.part=function(){var e;return null==this.sig?void console.error("No signaller set!"):(this.sig.signal("part"),void(null!=(e=this.stream)&&e.stop()))},e}(),d=function(){function e(e){this.vc=e,this.peers={}}e.displayName="SignallerSocketIO";var n=e.prototype;return n.connect=function(e,n){var o,t,i;return"undefined"==typeof io||null===io?void window.alert("Unable to connect to signalling server.\nChances are everything is OK on your end and the server is just down for some reason.\nIf it's not up again soon, email me at yousef@amar.io."):(o=this,t=io.connect(e),this.signal=function(e,n,i){return null==o.vc.user.id?void console.error("No UID assigned by server!"):(n=n||{},console.log("> ",e,n),void t.emit(e,n,i))},i=t,i.on("uid",function(e){console.log("< ","uid",e),o.vc.user.id=e,n(e)}),i.on("join",function(e){var n;console.log("< ","join",e),n=o.peers[e]=new u(e,o),n.addStream(o.vc.stream),n.createOffer()}),i.on("part",function(e){console.log("< ","part",e),delete o.peers[e],o.vc.onuserleft(e)}),i.on("sdp",function(e){var n,t;console.log("< ","sdp",e),n=e.sdp,"offer"===n.type&&(t=o.peers[e.userId]=new u(e.from,o),t.addStream(o.vc.stream),t.createAnswer(n)),"answer"===n.type&&o.peers[e.from].setRemoteDescription(n)}),void i.on("ice",function(e){var n;console.log("< ","ice",e),null!=(n=o.peers[e.from])&&n.addIceCandidate(e.candidate)}))},n.signal=function(){console.error("No signalling function set!")},e}(),u=function(){function i(n,o){var t,i;this.userId=n,this.sig=o,this.conn=t=new e(s,{optional:[{DtlsSrtpKeyAgreement:!0}]}),i=this,t.onaddstream=function(){var e;return e=o.vc.buildStreamHandler(n),function(n){e(n.stream)}}(),t.onicecandidate=function(e){e.candidate?i.onicecandidate(e.candidate,n):i.onsdp(t.localDescription,n)},t.ongatheringchange=function(e){e.currentTarget&&"complete"===e.currentTarget.iceGatheringState&&i.onsdp(t.localDescription,n)}}i.displayName="Peer";var r,a,c,d=i.prototype;return d.addStream=function(e){this.conn.addStream(e)},r={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},d.createOffer=function(){var e;e=this,this.conn.createOffer(function(n){e.conn.setLocalDescription(n),t&&e.onsdp(n,e.userId)},c,r)},d.createAnswer=function(e){var o;o=this,this.conn.setRemoteDescription(new n(e,a,c)),this.conn.createAnswer(function(e){o.conn.setLocalDescription(e),o.onsdp(e,o.userId)},c,r)},d.setRemoteDescription=function(e){this.conn.setRemoteDescription(new n(e,a,c))},d.addIceCandidate=function(e){this.conn.addIceCandidate(new o({sdpMLineIndex:e.sdpMLineIndex,candidate:e.candidate}))},d.onicecandidate=function(e,n){this.sig.signal("ice",{candidate:e,to:n})},d.onsdp=function(e,n){this.sig.signal("sdp",{sdp:e,to:n})},a=function(){},c=function(e){console.error("sdp error:",e.name,e.message)},i}(),function(){var e,n,o,t,i;return e=new c,n=document.getElementById("thumbnails"),o=null,t=function(e){null!=o&&(n.appendChild(o),o.play()),o=e,document.body.appendChild(o),o.play()},e.onaddstream=function(e){e.onclick=function(){t(e)},n.appendChild(e)},e.onuserleft=function(e){var n;n=document.getElementById(e),n&&n.parentNode.removeChild(n),n===o&&(o=null)},i=window.location.pathname.substring(1),i||(i="xxxxxx".replace(/[x]/g,function(){return(36*Math.random()|0).toString(36)}),window.history.replaceState({},"New Room ID","/"+i)),e.setSignaller(new d(e)).connect(window.CAMWIRE.DEBUG?"http://localhost:9980":"http://camwi.re:9980",function(){console.log("Joining room "+i),e.join("camwire-"+i)})})}).call(this);